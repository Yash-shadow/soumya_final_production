{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Bill Reimbursement Form - NPDCL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        /* Header - Same as dashboard */
        .header {
            background: linear-gradient(to right, #003366, #0066cc);
            padding: 0;
            color: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: white;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .minister-photo {
            width: 70px;
            height: 90px;
            border-radius: 5px;
            object-fit: cover;
        }

        .minister-info {
            color: #003366;
            font-size: 11px;
        }

        .minister-info strong {
            display: block;
            font-size: 12px;
            margin-top: 3px;
        }

        .company-logo {
            width: 80px;
            height: 80px;
        }

        .company-info {
            text-align: center;
            flex: 1;
            padding: 0 20px;
        }

        .company-title-telugu {
            font-size: 20px;
            color: #d32f2f;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .company-title-english {
            font-size: 16px;
            color: #d32f2f;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .company-subtitle {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }

        .rising-logo {
            width: 60px;
            height: 60px;
        }

        .header-nav {
            background-color: #003366;
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background-color: #0066cc;
        }

        .user-info {
            color: white;
            font-size: 13px;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .form-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            background-color: white;
            border: 2px solid #000;
            padding: 10px;
            margin-bottom: 20px;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border: 2px solid #003366;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background-color: #003366;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }

        .form-row {
            display: contents;
        }

        .form-label {
            background-color: #e3f2fd;
            padding: 10px 12px;
            border: 1px solid #b3d9ff;
            font-weight: bold;
            color: #003366;
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .form-input {
            background-color: #fffef0;
            padding: 8px 12px;
            border: 1px solid #b3d9ff;
        }

        .form-input input,
        .form-input select,
        .form-input textarea {
            width: 100%;
            border: 1px solid #ccc;
            padding: 6px 8px;
            font-size: 12px;
            background-color: #fffef0;
        }

        .form-input textarea {
            resize: vertical;
            min-height: 30px;
            /* Reduced from 60px */
            height: 30px;
        }

        .full-width {
            grid-column: span 4;
        }

        .half-width {
            grid-column: span 2;
        }

        .note-text {
            background-color: #fff9e6;
            padding: 10px 15px;
            border: 1px solid #ffd700;
            font-size: 11px;
            color: #856404;
            margin: 10px;
            border-radius: 4px;
        }

        /* Hospital Claim Details Table */
        .claim-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .claim-table th {
            background-color: #0066cc;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #003366;
        }

        .claim-table td {
            border: 1px solid #ddd;
            padding: 8px;
            background-color: #fffef0;
            text-align: center;
        }

        .claim-table input,
        .claim-table select {
            width: 100%;
            border: 1px solid #ccc;
            padding: 6px;
            font-size: 12px;
            background-color: white;
        }

        .claim-table input[type="number"] {
            text-align: right;
        }

        .claim-table textarea {
            width: 100%;
            border: 1px solid #ccc;
            padding: 4px;
            font-size: 11px;
            height: 30px;
            min-height: 30px;
            resize: vertical;
        }

        /* Buttons */
        .form-actions {
            text-align: center;
            padding: 20px;
            background-color: white;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .btn-submit {
            background-color: #0066cc;
            color: white;
        }

        .btn-submit:hover {
            background-color: #0052a3;
        }

        .btn-add {
            background-color: #28a745;
            color: white;
            padding: 8px 20px;
            font-size: 13px;
        }

        .btn-add:hover {
            background-color: #218838;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 11px;
        }

        .btn-remove:hover {
            background-color: #c82333;
        }

        .required {
            color: #d32f2f;
        }

        .attachment-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attachment-field input[type="file"] {
            flex: 1;
        }

        .attachment-label {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        .minister-photo {
            height: 180px;
            width: 100%
        }
    </style>
</head>

<body>
    <!-- Header -->
    <img src="/static/images/cmimage.png" alt="Deputy Chief Minister" class="minister-photo">

    <div class="header-nav">
        <div class="nav-links">
            <a href="{% url 'hospitals:dashboard' %}">Dashboard</a>
            <a href="{% url 'hospitals:submit_bill' %}" class="active">Submit New Claim</a>
            <a href="{% url 'hospitals:bill_list' %}">View All Claims</a>
        </div>
        <div class="user-info">
            Welcome, {{ request.user.profile.hospital.name }}
        </div>
    </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="form-title">Medical Bill Reimbursement Form</div>

        <form method="post" enctype="multipart/form-data" id="billForm">
            {% csrf_token %}

            <!-- Hospital Details Section -->
            <div class="form-section">
                <div class="section-header">HOSPITAL DETAILS</div>
                <div class="form-grid">
                    <div class="form-label">Name of the Hospital</div>
                    <div class="form-input">{{ request.user.profile.hospital.name }}</div>
                    <div class="form-label">Hospital PAN No:</div>
                    <div class="form-input">{{ request.user.profile.hospital.pan_number|default:"XXXXXXX" }}</div>

                    <div class="form-label">Address:</div>
                    <div class="form-input">{{ request.user.profile.hospital.address }}</div>
                    <div class="form-label">GST NO:</div>
                    <div class="form-input">{{ request.user.profile.hospital.gst_number|default:"XXXXXXXXX" }}</div>

                    <div class="form-label">Phone No:</div>
                    <div class="form-input">{{ request.user.profile.hospital.phone }}</div>
                    <div class="form-label">CIN NO:</div>
                    <div class="form-input">{{ request.user.profile.hospital.cin_number|default:"XXXXXXXXXX" }}</div>

                    <div class="form-label">Hospital Code:</div>
                    <div class="form-input">{{ request.user.profile.hospital.code }}</div>
                    <div class="form-label">Category:</div>
                    <div class="form-input">{{ request.user.profile.hospital.get_tier_display }}</div>
                </div>
                <div class="note-text">
                    <strong>Hospital Header Data:</strong> Remain Fixed Irrespective of Any Hospital <br>
                    <strong>Hospital Transactional Data:</strong> To be Picked from Hospital Master Data
                </div>
            </div>

            <!-- Patient Details Section -->
            <div class="form-section">
                <div class="section-header">PATIENT DETAILS</div>
                <div class="form-grid">
                    <div class="form-label">Name of the Employee: <span class="required">*</span></div>
                    <div class="form-input">
                        {{ bill_form.patient_name }}
                    </div>
                    <div class="form-label">Employee ID:</div>
                    <div class="form-input">
                        {{ bill_form.employee_id }}
                    </div>

                    <div class="form-label">Designation:</div>
                    <div class="form-input">
                        {{ bill_form.designation }}
                    </div>
                    <div class="form-label">Mobile No:</div>
                    <div class="form-input">
                        {{ bill_form.mobile_number }}
                    </div>

                    <div class="form-label">Name of the Patient:</div>
                    <div class="form-input" style="grid-column: span 3;">
                        {{ bill_form.patient_name }}
                    </div>
                </div>

                <!-- Custom Grid for 3-item rows -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); border-top: 1px solid #b3d9ff;">
                    <!-- Row 1: Age, Sex, Employee Type -->
                    <div class="form-label">AGE:</div>
                    <div class="form-input">{{ bill_form.age }}</div>

                    <div class="form-label">Sex:</div>
                    <div class="form-input">{{ bill_form.sex }}</div>

                    <div class="form-label">Employee Type:</div>
                    <div class="form-input">{{ bill_form.employee_type }}</div>

                    <!-- Row 2: Relationship, Date of Admission, Date of Discharge (Logical grouping) -->
                    <!-- or "employee ype, relationship and date of admission" as user said? 
                         Assuming user repeated 'employee type' by mistake and meant:
                         Relationship, Admission Date, Discharge Date/Disease Details -->

                    <div class="form-label">Relationship:</div>
                    <div class="form-input">{{ bill_form.relationship }}</div>

                    <div class="form-label">Date of Admission:</div>
                    <div class="form-input">{{ bill_form.admission_date }}</div>

                    <!-- Fitting one more item to make it 3 -->
                    <div class="form-label">Date of Discharge:</div>
                    <div class="form-input">{{ bill_form.discharge_date }}</div>

                    <!-- Row 3: Remaining items -->
                    <!-- Row 3: Credit Card and IP Number -->
                    <div class="form-label">Credit Card Number:</div>
                    <div class="form-input" style="grid-column: span 2;">{{ bill_form.credit_card_number }}</div>

                    <div class="form-label">IP Number:</div>
                    <div class="form-input" style="grid-column: span 2;">{{ bill_form.ip_number }}</div>

                    <!-- Row 4: Name of Disease (Full Width) -->
                    <div class="form-label">Name of Disease:</div>
                    <div class="form-input" style="grid-column: span 5;">{{ bill_form.disease_details }}</div>
                </div>

                <!-- Resume original grid for any footer items if needed, but we closed the div above -->
                <div class="form-grid" style="display: none;"></div>

                <div class="note-text">
                    <strong>Patient Header Data:</strong> Remain Fixed Irrespective of Any Patient <br>
                    <strong>Patient Transactional Data:</strong> To be Filled Manually by Logged-In Hospital <br>
                    <strong>Attach ID Card:</strong>
                    <div class="attachment-field">
                        {{ bill_form.id_card_file }}
                        <span class="attachment-label">Upload Employee/Pensioner ID Card</span>
                    </div>
                    <strong>Attach Approved CC Card:</strong>
                    <div class="attachment-field">
                        {{ bill_form.cc_card_file }}
                        <span class="attachment-label">Upload Credit Card Approval</span>
                    </div>
                    <strong>Attach Discharge Summary:</strong>
                    <div class="attachment-field">
                        {{ bill_form.discharge_summary_file }}
                        <span class="attachment-label">Upload Discharge Summary</span>
                    </div>
                </div>
            </div>

            <!-- Hospital Claim Details Section -->
            <div class="form-section">
                <div class="section-header">HOSPITAL CLAIM DETAILS</div>
                <div style="padding: 15px;">
                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-label">Invoice No: <span class="required">*</span></div>
                        <div class="form-input">
                            {{ bill_form.bill_number }}
                        </div>
                        <div class="form-label">Invoice Date: <span class="required">*</span></div>
                        <div class="form-input">
                            {{ bill_form.bill_date }}
                        </div>

                        <div class="form-label">Gross Total:</div>
                        <div class="form-input" style="grid-column: span 3;">
                            <small class="text-muted"
                                style="display: block; font-size: 0.7rem; margin-bottom: 3px;">Attach supporting doc
                                (Mandatory)</small>
                            <input type="file" name="bill_attachment" class="form-control"
                                style="font-size: 0.8rem; margin-bottom: 5px;" required>

                            <input type="number" id="grossTotal" value="0" readonly style="background-color: #e9ecef;">
                        </div>
                    </div>

                    <table class="claim-table">
                        <thead style="background-color: #0066cc; color: white;">
                            <tr>
                                <th style="width: 50px;">SL NO.</th>
                                <th style="width: 15%;">Service Description as per Rate <span class="required">*</span>
                                </th>
                                <th style="width: 20%;">Details of Services (Hospital)</th>
                                <th style="width: 10%;">Rate</th>
                                <th style="width: 8%;">Quantity</th>
                                <th style="width: 10%;">Amount</th>
                                <th style="width: 10%;">Attachments</th>
                                <th style="width: 5%;">Remarks</th>
                                <th style="width: 13%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            {{ formset.management_form }}

                            {% for form in formset %}
                            <tr class="item-row">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    {{ form.service }}
                                    {{ form.id }}
                                </td>
                                <td>
                                    <input type="text" name="{{ form.prefix }}-hospital_service_name"
                                        class="hospital-service-input" placeholder="Enter service name"
                                        style="width: 100%; padding: 6px; font-size: 12px;">
                                </td>
                                <td>
                                    {{ form.claimed_rate }}
                                </td>
                                <td>
                                    {{ form.claimed_quantity }}
                                </td>
                                <td>
                                    {{ form.claimed_amount }}
                                </td>
                                <td>
                                    {{ form.supporting_document }}
                                </td>
                                <td>
                                    {{ form.description }}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-remove"
                                        onclick="removeRow(this)">Remove</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Empty Form Template -->
                    <div id="empty-form" style="display: none;">
                        <table>
                            <tr class="item-row">
                                <td>#</td>
                                <td>
                                    {{ formset.empty_form.service }}
                                </td>
                                <td>
                                    <input type="text" name="form-__prefix__-hospital_service_name"
                                        class="hospital-service-input" placeholder="Enter service name"
                                        style="width: 100%; padding: 6px; font-size: 12px;">
                                </td>
                                <td>
                                    {{ formset.empty_form.claimed_rate }}
                                </td>
                                <td>
                                    {{ formset.empty_form.claimed_quantity }}
                                </td>
                                <td>
                                    {{ formset.empty_form.claimed_amount }}
                                </td>
                                <td>
                                    {{ formset.empty_form.supporting_document }}
                                </td>
                                <td>
                                    {{ formset.empty_form.description }}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-remove"
                                        onclick="removeRow(this)">Remove</button>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div style="text-align: center; margin: 15px 0;">
                        <button type="button" class="btn btn-add" onclick="addRow()">+ Add Service Line</button>
                    </div>
                </div>
                <div class="note-text">
                    <strong>Attach Supporting Docs:</strong> Final Invoice, Detailed Bill, Pharmacy Bills etc. <br>
                    <strong>Attach Final Invoice:</strong> Detail Breakup Line Items Done
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-submit">Submit Claim</button>
                <button type="button" class="btn" onclick="window.history.back()"
                    style="background-color: #6c757d; color: white;">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        function addRow() {
            const formIdx = document.getElementById('id_form-TOTAL_FORMS').value;
            const emptyFormHtml = document.getElementById('empty-form').innerHTML;
            const newHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

            // Extract the TR from the table in empty-form
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newHtml;
            const newRow = tempDiv.querySelector('tr');

            document.getElementById('itemsTableBody').appendChild(newRow);
            document.getElementById('id_form-TOTAL_FORMS').value = parseInt(formIdx) + 1;

            // Ensure inputs have correct classes for listeners if missing
            newRow.querySelector('select[name$="-service"]').classList.add('service-select');
            newRow.querySelectorAll('input[name$="-claimed_rate"]').forEach(el => el.classList.add('rate-input'));
            newRow.querySelectorAll('input[name$="-claimed_quantity"]').forEach(el => el.classList.add('qty-input'));
            newRow.querySelectorAll('input[name$="-claimed_amount"]').forEach(el => el.classList.add('amount-input'));

            attachRowListeners(newRow);
            updateRowNumbers();
        }

        function removeRow(button) {
            const row = button.closest('tr');
            // Check if it's the only row left (excluding management form)
            if (document.querySelectorAll('.item-row').length > 1) {
                row.remove();
                reindexForms();
                updateRowNumbers();
                updateGrossTotal();
            } else {
                alert('At least one service line is required.');
            }
        }

        function reindexForms() {
            const rows = document.querySelectorAll('.item-row');
            document.getElementById('id_form-TOTAL_FORMS').value = rows.length;

            rows.forEach((row, index) => {
                row.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.name) {
                        // Replace the index in name and id (e.g., form-5-field -> form-2-field)
                        input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
                        input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
                    }
                });
            });
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('.item-row');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        function updateGrossTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const amountInput = row.querySelector('.amount-input') || row.querySelector('input[name$="-claimed_amount"]');
                if (amountInput && amountInput.value) {
                    total += parseFloat(amountInput.value) || 0;
                }
            });
            const grossInput = document.getElementById('grossTotal');
            if (grossInput) grossInput.value = total.toFixed(2);
        }

        function calculateAmount(row) {
            const rateInput = row.querySelector('.rate-input') || row.querySelector('input[name$="-claimed_rate"]');
            const qtyInput = row.querySelector('.qty-input') || row.querySelector('input[name$="-claimed_quantity"]');
            const amountInput = row.querySelector('.amount-input') || row.querySelector('input[name$="-claimed_amount"]');

            if (rateInput && qtyInput && amountInput) {
                const rate = parseFloat(rateInput.value) || 0;
                const qty = parseFloat(qtyInput.value) || 0;
                amountInput.value = (rate * qty).toFixed(2);
                updateGrossTotal();
            }
        }

        function attachRowListeners(row) {
            // Add classes dynamically if they are missing (standard Django widgets don't always have our classes)
            const serviceSelect = row.querySelector('select[name$="-service"]');
            if (serviceSelect) {
                serviceSelect.classList.add('service-select');
                serviceSelect.addEventListener('change', function () {
                    const selectedOption = this.options[this.selectedIndex];
                    // Note: accessing data attributes from Django widget might need custom widget or JS helper
                    // Here we assume standard select. If we need data-rate, we might need to look it up 
                    // or ensure the widget renders it.
                    // For now, let's assume the user enters Rate manually, or we fetch it.
                    // If the previous template had data-rate, we need to ensure it's still there.
                    // But Django Select widget doesn't output data-rate on options easily.
                    // So we might skip auto-fill for now or handle it via AJAX if critical.
                    // Since user said "submit quantity and rate", manual entry is the focus.
                });
            }

            const rateInput = row.querySelector('input[name$="-claimed_rate"]');
            if (rateInput) {
                rateInput.classList.add('rate-input');
                rateInput.addEventListener('input', () => calculateAmount(row));
            }

            const qtyInput = row.querySelector('input[name$="-claimed_quantity"]');
            if (qtyInput) {
                qtyInput.classList.add('qty-input');
                qtyInput.addEventListener('input', () => calculateAmount(row));
            }

            const amountInput = row.querySelector('input[name$="-claimed_amount"]');
            if (amountInput) amountInput.classList.add('amount-input');
        }

        // Initialize event listeners on page load
        document.addEventListener('DOMContentLoaded', function () {
            // If the formset loop was empty (extra=0), we should add one empty row to start
            if (document.querySelectorAll('.item-row').length === 0) {
                addRow();
            } else {
                document.querySelectorAll('.item-row').forEach(row => {
                    attachRowListeners(row);
                });
            }

            // Date Validation
            const admissionDateInput = document.getElementById('id_admission_date');
            const dischargeDateInput = document.getElementById('id_discharge_date');

            function validateDates() {
                const admissionDate = new Date(admissionDateInput.value);
                const dischargeDate = new Date(dischargeDateInput.value);

                if (admissionDateInput.value && dischargeDateInput.value) {
                    if (dischargeDate < admissionDate) {
                        alert('please choose correct date'); // As requested by user
                        dischargeDateInput.value = ''; // Clear invalid date
                    }
                }
            }

            if (admissionDateInput && dischargeDateInput) {
                admissionDateInput.addEventListener('change', validateDates);
                dischargeDateInput.addEventListener('change', validateDates);
            }
        });
    </script>
</body>

</html>